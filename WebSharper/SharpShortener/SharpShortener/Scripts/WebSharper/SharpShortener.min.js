(function(){var $$=this,$=this.IntelliFactory.Runtime,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L;$.Define($$,{SharpShortener:{Addresse:{externFromString:function(M,N){return b.bind(function(O){return d.externFromUrl(M,O);},e.fromString(N));},externFromUrl:function(P,Q){return d.isLink(P,Q)?{$:0}:{$:1,$0:{$:0,$0:Q}};},externToUrl:function(R){return R.$0;},getId:function(S){return S.$0;},isLink:function(T,U){return d.linkFromUrl(T,U).$==1;},link:function(V){return{$:0,$0:V};},linkFromString:function(W,X){return b.bind(function(Y){return d.linkFromUrl(W,Y);},e.fromString(X));},linkFromUrl:function(Z,_0){return b.map(function(_1){return{$:0,$0:_1};},b.bind(function(_2){return f.stringToId(_2);},d.tryGetHash(Z,_0)));},linkToUrl:function(_3,_4){return e.fromString(_3+$$.String(f.fromId(_4.$0))).$0;},tryGetHash:function(_5,_6){var _7,_8;_7=$$.String(_6);if(g.StartsWith(_7,_5)){return{$:1,$0:_7.substring(_5.length)};}else{_8="http://"+_7;return g.StartsWith(_8,_5)?{$:1,$0:_8.substring(_5.length)}:{$:0};}}},Controls:{Feedback:$.Class({get_Body:function(){return h.Main(this.baseAdr);}}),Shorten:$.Class({get_Body:function(){return i.Main();}}),Stats:$.Class({get_Body:function(){return j.Main();}})},FeedbackPagelet:{FeedbackFormlet:function(_9){var _,ba,bc,bd,be,bf,bg,bh,bi,bj,bm,bo,bq,bs,bt,bu,bv,by,bz,bC;_=l.Input("");ba=function(bb){return{$:0,$0:bb};};bc=(m.Validator().IsEmail("Bitte geben Sie eine gültige Email an"))(_);bd=n.WithTextLabel("Email",o.Map(ba,bc));be=n.WithValidationIcon(bd);bf=l.TextArea("");bg=m.Validator().IsNotEmpty("Bitte eine Nachricht eingeben",bf);bh=n.WithTextLabel("Nachricht",bg);bi=n.WithValidationIcon(bh);bj=m.$(m.$(o.Return(function(bk){return function(bl){return{$:1,$0:[bk,bl]};};}),be),bi);bm=function(bn){return bn.$==1;};bo=o.Map(function(bp){return d.linkFromString(_9,bp);},l.Input(""));bq=n.WithTextLabel("Link",o.Map(function(br){return d.getId(br.$0);},m.Validator().Is(bm,"bitte geben Sie eine gekürzte URL ein",bo)));bs=n.WithValidationIcon(bq);bt=p.ofArray([["Link funktioniert nicht",{$:0}],["unangebrachter Inhalt",{$:1}]]);bu=l.Select(0,bt);bv=m.$(m.$(o.Return(function(bw){return function(bx){return{$:0,$0:[bx,bw]};};}),bu),bs);by=o.Do();bz=by.Delay(function(){return by.Bind(l.Select(0,p.ofArray([["Link melden",bv],["Kontakt",bj]])),function(bB){return by.ReturnFrom(bB);});});bC=q.get_Default();return n.WithCssClass("feedback",n.WithFormContainer(n.WithCustomSubmitButton($.New(q,{Label:{$:1,$0:"Abschicken"},Style:bC.Style,Class:bC.Class}),bz)));},Main:function(bC){return o.Run(function(bD){return bD.$==1?r("Vielen Dank für Ihr Feedback "+bD.$0[0].$0):r("Vielen Dank, wir werden uns um den Link kümmern");},h.FeedbackFormlet(bC));}},Hash:{T:$.Class({toString:function(){return this.$0;}}),alphabet:$.Field(function(){return p.concat(p.ofArray([s.toList(t.range(97,122)),s.toList(t.range(48,57))]));}),alphabetLen:$.Field(function(){return f.alphabet().get_Length();}),fromId:function(bE){var bF,bG;bF="";bG=bE;while(bG>0){bF=bF+u.fromCharCode(f.alphabet().get_Item(bG%f.alphabetLen()<<0));bG=bG/f.alphabetLen()>>0;}return $.New(v,{$:0,$0:bF});},indexOf:$.Field(function(){var bH;bH=x.OfArray(s.toArray(p.zip(f.alphabet(),s.toList(t.range(0,f.alphabet().get_Length()-1)))));return function(bI){return bH.get_Item(bI);};}),stringToId:function(bJ){var bM;if(bJ.indexOf("/")!=-1){return{$:0};}else{try{return{$:1,$0:p.foldBack(function(bK){return function(bL){return bL*f.alphabetLen()+(f.indexOf())(bK);};},p.ofSeq(bJ),0)};}catch(bM){return{$:0};}}},toId:function(bN){return f.stringToId(bN.$0).$0;}},ShortenPagelet:{Main:function(){var bO,bP;bO=z.Input(p.ofArray([z.Text("")]));bP=z.Button(p.ofArray([z.Text("Kürzen")]));i.wireUp(bP,bO);return A.add(z.Div(p.ofArray([bO,bP])),p.ofArray([z.Attr().Class("eingabe")]));},enableElement:function(bQ,bR){return!bR?bQ["HtmlProvider@32"].SetAttribute(bQ.Body,"disabled",""):bQ["HtmlProvider@32"].RemoveAttribute(bQ.Body,"disabled");},getValue:function(bS,bT){return bS(bT.get_Value());},requestShortenedUrl:function(bV,bW){return B.Start(B.Delay(function(){return B.Bind(C.Async("SharpShortener:0",[bW]),function(bY){return B.Return(bV(bY));});}));},setText:function(bZ,b0){return bZ.set_Text(b0);},setValue:function(b1,b2,b3){return b2.set_Value(b1(b3));},wireUp:function(b4,b5){var b6,b9,b$,cb,cd,ck,cm;b6=function(b7){return i.getValue(function(b8){return e.fromString(b8);},b5,b7);};b9=function(b_){return $$.String(b_);};b$=function(){return"";};cb=function(){if(b6(null).$==0){i.enableElement(b4,false);return i.setText(b4,"...");}else{i.enableElement(b4,true);return i.setText(b4,"kürzen");}};cd=function(){return function(){var cg,ch,ci;cg=b6(null);if(cg.$==0){return null;}else{ch=cg.$0;ci=function(cj){i.enableElement(b4,true);i.enableElement(b5,true);if(cj.$==0){i.setValue(b$,b5,null);}else{i.setValue(b9,b5,cj.$0);b5.Body.select();}return cb(null);};i.enableElement(b4,false);i.enableElement(b5,false);return i.requestShortenedUrl(ci,ch);}};};D.Events().OnClick(cd,b4);ck=function(){return cb(null);};D.Events().OnChange(ck,b5);cm=function(){return function(){return cb(null);};};D.Events().OnKeyUp(cm,b5);return i.enableElement(b4,false);}},StatsPagelet:{Main:function(){return A.add(z.Div(p.ofArray([z.H2(p.ofArray([z.Text("Besucherzähler der registrierten Seiten")])),j.StatsChart()])),p.ofArray([z.Attr().Class("statistik")]));},StatsChart:function(){var cp;cp=z.Div($.New(E,{$:0}));A.OnAfterRender(function(cq){var cr;cr={};cr.position="bottom";return j.getStatsData(new H(cq.Body),{width:600,height:300,legend:cr,title:"Hitcounter"});},cp);return cp;},getStatsData:function(cs,ct){return B.Start(B.Delay(function(){var cv,cw;cv=C.Call("SharpShortener:1",[]);cw=new I();cw.addColumn("string","url");cw.addColumn("number","#hits");J.iter($.Tupled(function(cx){var cy,cz,cA;cy=cx[0];cz=cx[1];cA=cw.addRow();cw.setValue(cA,0,e.nameOnly(cy));return cw.setValue(cA,1,cz);}),cv);cs.draw(cw,ct);return B.Return(null);}));}},Url:{T:$.Class({toString:function(){return this.$0;}}),fromString:function(cB){return e.isValidUrl(cB.toLowerCase())?{$:1,$0:$.New(K,{$:0,$0:e.withProtocol(cB)})}:{$:0};},isValidUrl:function(cC){return(new L(e.pattern())).test(cC);},nameOnly:function(cD){return e.withoutWWW(e.withoutProtocol($$.String(cD.$0).toLowerCase()));},pattern:$.Field(function(){return"^(https?:\\/\\/)?(www\\.)?(\\w+.?)+$";}),withProtocol:function(cE){return(g.StartsWith(cE,"http://")?true:g.StartsWith(cE,"https://"))?cE:"http://"+cE;},withoutProtocol:function(cF){return g.Replace(g.Replace(cF,"http://",""),"https://","");},withoutWWW:function(cG){return g.Replace(cG,"www.","");}}}});$.OnInit(function(){a=$.Safe($$.IntelliFactory.WebSharper);b=$.Safe(a.Option);c=$.Safe($$.SharpShortener);d=$.Safe(c.Addresse);e=$.Safe(c.Url);f=$.Safe(c.Hash);g=$.Safe(a.Strings);h=$.Safe(c.FeedbackPagelet);i=$.Safe(c.ShortenPagelet);j=$.Safe(c.StatsPagelet);k=$.Safe(a.Formlet);l=$.Safe(k.Controls);m=$.Safe(k.Data);n=$.Safe(k.Enhance);o=$.Safe(k.Formlet);p=$.Safe(a.List);q=$.Safe(n.FormButtonConfiguration);r=$.Safe($$.alert);s=$.Safe(a.Seq);t=$.Safe(a.Operators);u=$.Safe($$.String);v=$.Safe(f.T);w=$.Safe(a.Collections);x=$.Safe(w.MapModule);y=$.Safe(a.Html);z=$.Safe(y.Default);A=$.Safe(y.Operators);B=$.Safe(a.Concurrency);C=$.Safe(a.Remoting);D=$.Safe(y.EventsPervasives);E=$.Safe(p.T);F=$.Safe($$.google);G=$.Safe(F.visualization);H=$.Safe(G.ColumnChart);I=$.Safe(G.DataTable);J=$.Safe(a.Arrays);K=$.Safe(e.T);return L=$.Safe($$.RegExp);});$.OnLoad(function(){e.pattern();f.indexOf();f.alphabetLen();f.alphabet();return;});}());
